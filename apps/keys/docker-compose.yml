services:
    base:
        build:
            context: .
            dockerfile: ./Dockerfile.base
        image: vpn-base
        
    app:
        image: keys-bot
        container_name: keys-bot
        build:
            context: .
            dockerfile: ./Dockerfile
        env_file: .env
        cap_add:
            - NET_ADMIN
        devices:
            - /dev/net/tun
        depends_on:
            - base
        privileged: true
        ports:
            - 500:500
            - 4500:4500        
        restart: always
        volumes:
            - ${IKE_CLIENTS_DIR}:${IKE_CONTAINER_DIR:-/app/ikev2-clients}
            - ${WG_CLIENTS_DIR}:${WG_CONTAINER_DIR:-/app/wg-clients}
            - ${OVPN_CLIENTS_DIR}:${OVPN_CONTAINER_DIR:-/app/ovpn-clients}
            - ./scripts:/app/scripts:ro
            - /usr/bin/wireguard.sh:/usr/bin/wireguard.sh:ro
            - /usr/bin/openvpn.sh:/usr/bin/openvpn.sh:ro
            - /etc/ipsec.d:/etc/ipsec.d
            - /lib/modules:/lib/modules:ro
            - /etc/wireguard:/etc/wireguard
            - /etc/sysctl.conf:/etc/sysctl.conf:ro
            - /etc/sysctl.d:/etc/sysctl.d:ro
            - /usr/local/sbin:/usr/local/sbin:ro
            - /usr/local/libexec:/usr/local/libexec:ro
            - /usr/bin/vnstat:/usr/bin/vnstat:ro
            # OpenVPN
            - /etc/openvpn:/etc/openvpn
            - /etc/openvpn/server:/etc/openvpn/server
            - /etc/openvpn/server/easy-rsa/easyrsa:/etc/openvpn/server/easy-rsa/easyrsa:ro
            - /etc/openvpn/client:/etc/openvpn/client
            - /etc/openvpn/update-resolv-conf:/etc/openvpn/update-resolv-conf:ro
            - /var/log/openvpn:/var/log/openvpn
            - /usr/sbin/openvpn:/usr/sbin/openvpn:ro
            - /usr/bin/openssl:/usr/bin/openssl:ro
            - /etc/ssl:/etc/ssl:ro
            - /etc/pki:/etc/pki:ro
